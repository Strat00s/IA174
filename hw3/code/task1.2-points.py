{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Elliptic Curve defined by y^2 = x^3 + 2023*x over Ring of integers modulo 39994164849376373681302869279978885783653661374456939385898429379205375386189\n",
      "(23276472213876450688187000051254953380237023292994242238544486040529380419970 : 31975737335232659695723490072292259215726768073839889041012142074834353107954 : 1)\n",
      "(0 : 1 : 0)\n",
      "(12016455826322587254171332197242588164952855197335449999871359431274478042739 : 25927346627286978519142378766841887155559783122479065444158612164844671621772 : 1)\n",
      "(0 : 1 : 0)\n",
      "(2843707228271856607862735756446869815195553504007690235513735083758171787983 : 24056622931458612390810344888295484246014059489940782339859780490025530182541 : 1)\n",
      "39994164849376373681302869279978885783260159848204277050736846327351841544490\n",
      "[2, 5, 13, 17, 29, 37, 41, 53, 61, 73, 89, 97, 101, 109, 113, 137, 149, 157, 173, 181, 193]\n",
      "0\n",
      "4772884755969261972908097569724184930\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/home/stratos/mambaforge/envs/sage/lib/python3.10/site-packages/sage/schemes/generic/morphism.py:398: RuntimeWarning: cypari2 leaked 61344 bytes on the PARI stack\n",
      "  return coercion_model.bin_op(self, right, operator.mul)\n"
     ]
    },
    {
     "ename": "KeyboardInterrupt",
     "evalue": "",
     "output_type": "error",
     "traceback": [
      "\u001b[0;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[0;31mKeyboardInterrupt\u001b[0m                         Traceback (most recent call last)",
      "Cell \u001b[0;32mIn [5], line 37\u001b[0m\n\u001b[1;32m     34\u001b[0m \u001b[38;5;28mprint\u001b[39m(modulus)\n\u001b[1;32m     36\u001b[0m \u001b[38;5;28;01mwhile\u001b[39;00m \u001b[38;5;28;01mTrue\u001b[39;00m:\n\u001b[0;32m---> 37\u001b[0m     \u001b[38;5;28;01mif\u001b[39;00m \u001b[43mgenerator\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;241;43m*\u001b[39;49m\u001b[43m \u001b[49m\u001b[43mn\u001b[49m \u001b[38;5;241m==\u001b[39m pubkey:\n\u001b[1;32m     38\u001b[0m         \u001b[38;5;28mprint\u001b[39m(n)\n\u001b[1;32m     39\u001b[0m         \u001b[38;5;28;01mbreak\u001b[39;00m\n",
      "File \u001b[0;32m~/mambaforge/envs/sage/lib/python3.10/site-packages/sage/schemes/generic/morphism.py:398\u001b[0m, in \u001b[0;36mSchemeMorphism.__mul__\u001b[0;34m(self, right)\u001b[0m\n\u001b[1;32m    345\u001b[0m \u001b[38;5;124;03m\"\"\"\u001b[39;00m\n\u001b[1;32m    346\u001b[0m \u001b[38;5;124;03mWe can currently only multiply scheme morphisms.\u001b[39;00m\n\u001b[1;32m    347\u001b[0m \n\u001b[0;32m   (...)\u001b[0m\n\u001b[1;32m    395\u001b[0m \u001b[38;5;124;03m      Defn: Structure map) codomain\u001b[39;00m\n\u001b[1;32m    396\u001b[0m \u001b[38;5;124;03m\"\"\"\u001b[39;00m\n\u001b[1;32m    397\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;28misinstance\u001b[39m(right, SchemeMorphism):\n\u001b[0;32m--> 398\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[43mcoercion_model\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mbin_op\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mright\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43moperator\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mmul\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m    399\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m right\u001b[38;5;241m.\u001b[39mcodomain() \u001b[38;5;241m!=\u001b[39m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mdomain():\n\u001b[1;32m    400\u001b[0m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mTypeError\u001b[39;00m(\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mself (=\u001b[39m\u001b[38;5;132;01m%s\u001b[39;00m\u001b[38;5;124m) domain must equal right (=\u001b[39m\u001b[38;5;132;01m%s\u001b[39;00m\u001b[38;5;124m) codomain\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;241m%\u001b[39m(\u001b[38;5;28mself\u001b[39m, right))\n",
      "File \u001b[0;32m~/mambaforge/envs/sage/lib/python3.10/site-packages/sage/structure/coerce.pyx:1104\u001b[0m, in \u001b[0;36msage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:12011)\u001b[0;34m()\u001b[0m\n\u001b[1;32m   1102\u001b[0m     return ret\n\u001b[1;32m   1103\u001b[0m \n\u001b[0;32m-> 1104\u001b[0m cpdef bin_op(self, x, y, op):\n\u001b[1;32m   1105\u001b[0m     \"\"\"\n\u001b[1;32m   1106\u001b[0m     Execute the operation op on x and y. It first looks for an action\n",
      "File \u001b[0;32m~/mambaforge/envs/sage/lib/python3.10/site-packages/sage/structure/coerce.pyx:1196\u001b[0m, in \u001b[0;36msage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:10795)\u001b[0;34m()\u001b[0m\n\u001b[1;32m   1194\u001b[0m         return (<Action>action)._act_(x, y)\n\u001b[1;32m   1195\u001b[0m     else:\n\u001b[0;32m-> 1196\u001b[0m         return (<Action>action)._act_(y, x)\n\u001b[1;32m   1197\u001b[0m \n\u001b[1;32m   1198\u001b[0m # Now coerce to a common parent and do the operation there\n",
      "File \u001b[0;32m~/mambaforge/envs/sage/lib/python3.10/site-packages/sage/structure/coerce_actions.pyx:153\u001b[0m, in \u001b[0;36msage.structure.coerce_actions.ActedUponAction._act_ (build/cythonized/sage/structure/coerce_actions.c:4741)\u001b[0;34m()\u001b[0m\n\u001b[1;32m    151\u001b[0m     <... 'sage.structure.coerce_actions.ActedUponAction'>\n\u001b[1;32m    152\u001b[0m \"\"\"\n\u001b[0;32m--> 153\u001b[0m return (<Element>x)._acted_upon_(g, not self._is_left)\n\u001b[1;32m    154\u001b[0m \n\u001b[1;32m    155\u001b[0m \n",
      "File \u001b[0;32m~/mambaforge/envs/sage/lib/python3.10/site-packages/sage/structure/element.pyx:954\u001b[0m, in \u001b[0;36msage.structure.element.Element._acted_upon_ (build/cythonized/sage/structure/element.c:9172)\u001b[0;34m()\u001b[0m\n\u001b[1;32m    952\u001b[0m     return None\n\u001b[1;32m    953\u001b[0m \n\u001b[0;32m--> 954\u001b[0m cpdef _acted_upon_(self, x, bint self_on_left):\n\u001b[1;32m    955\u001b[0m     \"\"\"\n\u001b[1;32m    956\u001b[0m     Use this method to implement ``self`` acted on by x.\n",
      "File \u001b[0;32m~/mambaforge/envs/sage/lib/python3.10/site-packages/sage/schemes/elliptic_curves/ell_point.py:3499\u001b[0m, in \u001b[0;36mEllipticCurvePoint_finite_field._acted_upon_\u001b[0;34m(self, other, side)\u001b[0m\n\u001b[1;32m   3496\u001b[0m E \u001b[38;5;241m=\u001b[39m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mcurve()\n\u001b[1;32m   3498\u001b[0m \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[0;32m-> 3499\u001b[0m     pariQ \u001b[38;5;241m=\u001b[39m \u001b[43mpari\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mellmul\u001b[49m\u001b[43m(\u001b[49m\u001b[43mE\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mk\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m   3500\u001b[0m \u001b[38;5;28;01mexcept\u001b[39;00m PariError:\n\u001b[1;32m   3501\u001b[0m     pariQ \u001b[38;5;241m=\u001b[39m \u001b[38;5;28;01mNone\u001b[39;00m\n",
      "File \u001b[0;32mcypari2/auto_instance.pxi:9196\u001b[0m, in \u001b[0;36mcypari2.pari_instance.Pari_auto.ellmul\u001b[0;34m()\u001b[0m\n",
      "\u001b[0;31mKeyboardInterrupt\u001b[0m: "
     ]
    }
   ],
   "source": [
    "p = 0x586be5268256ae12d62631efc2784d02dcff420d262da9cd94c62d5808bee24d\n",
    "a = 0x7e7\n",
    "b = 0x0\n",
    "\n",
    "pub_x = 0x1a9112ae9ac6b30cb8f899f9ed76b4c3826b758d5c98a840afd9eee17d09fe73\n",
    "pub_y = 0x39525bafcf33493141fd3f57d170f69af4ce41cd76ddb0f418781db2b4da5a8c\n",
    "\n",
    "\n",
    "ecurve    = EllipticCurve(Zmod(p), [a, b])\n",
    "generator = ecurve.gens()[0]\n",
    "pubkey    = ecurve.point((pub_x, pub_y))\n",
    "order     = ecurve.order()\n",
    "factors   = [x*y for (x, y) in order.factor()[:-2]]\n",
    "\n",
    "print(ecurve)\n",
    "print(generator)\n",
    "print(pubkey)\n",
    "print(order)\n",
    "print(factors)\n",
    "\n",
    "residues = []\n",
    "for factor in factors:\n",
    "    a =  generator * (order // factor)\n",
    "    b =  pubkey * (order // factor)\n",
    "    i = discrete_log(b, a, a.order(), operation='+')\n",
    "    residues.append(i)\n",
    "\n",
    "n = crt(residues, factors)\n",
    "print(n)\n",
    "modulus = prod(factors)\n",
    "print(modulus)\n",
    "\n",
    "while True:\n",
    "    if generator * n == pubkey:\n",
    "        print(n)\n",
    "        break\n",
    "    n += modulus\n",
    "\n",
    "print(\"end\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "SageMath 9.7",
   "language": "sage",
   "name": "sagemath"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.8"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
